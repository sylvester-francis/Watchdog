{{define "admin.html"}}
{{template "base" .}}
{{end}}

{{define "content"}}
<!-- System Health -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Database -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <div class="flex items-center justify-between mb-1">
            <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Database</p>
            {{if .DBHealthy}}
            <span class="w-2 h-2 rounded-full bg-green-500"></span>
            {{else}}
            <span class="w-2 h-2 rounded-full bg-red-500"></span>
            {{end}}
        </div>
        <p class="text-xl font-semibold text-foreground">{{.PingLatency}}</p>
        <p class="text-[10px] text-muted-foreground mt-0.5">ping latency</p>
    </div>

    <!-- Connection Pool -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Connection Pool</p>
        <p class="text-xl font-semibold text-foreground">{{.PoolAcquired}} <span class="text-sm font-normal text-muted-foreground">/ {{.PoolTotal}}</span></p>
        <p class="text-[10px] text-muted-foreground mt-0.5">acquired &middot; {{.PoolIdle}} idle</p>
    </div>

    <!-- Connected Agents -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Connected Agents</p>
        <p class="text-xl font-semibold text-foreground">{{.AgentCount}}</p>
        <p class="text-[10px] text-muted-foreground mt-0.5">active websocket connections</p>
    </div>

    <!-- Uptime -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Uptime</p>
        <p class="text-xl font-semibold text-foreground">{{.Uptime}}</p>
        <p class="text-[10px] text-muted-foreground mt-0.5">since last restart</p>
    </div>
</div>

<!-- Migration Status + Config Overview -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <!-- Migration Status -->
    <div class="bg-card rounded-lg border border-border">
        <div class="px-4 py-3 border-b border-border">
            <h2 class="text-sm font-medium text-foreground">Migration Status</h2>
        </div>
        <div class="px-4 py-3 space-y-2">
            <div class="flex items-center justify-between">
                <span class="text-xs text-muted-foreground">Current Version</span>
                <span class="text-sm font-medium text-foreground font-mono">{{.Migration.Version}}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs text-muted-foreground">Dirty</span>
                {{if .Migration.Dirty}}
                <span class="px-2 py-0.5 text-xs rounded bg-red-500/20 text-red-400">Yes</span>
                {{else}}
                <span class="px-2 py-0.5 text-xs rounded bg-green-500/20 text-green-400">No</span>
                {{end}}
            </div>
            <div class="flex items-center justify-between">
                <span class="text-xs text-muted-foreground">Total Applied</span>
                <span class="text-sm font-medium text-foreground font-mono">{{.TotalMigrations}}</span>
            </div>
        </div>
    </div>

    <!-- Config Overview -->
    <div class="bg-card rounded-lg border border-border">
        <div class="px-4 py-3 border-b border-border">
            <h2 class="text-sm font-medium text-foreground">Config Overview</h2>
        </div>
        <div class="px-4 py-3 space-y-3 max-h-64 overflow-y-auto">
            {{range .ConfigSections}}
            <div>
                <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider mb-1.5">{{.Name}}</p>
                {{range .Entries}}
                <div class="flex items-center justify-between py-0.5">
                    <span class="text-xs text-muted-foreground">{{.Key}}</span>
                    <span class="text-xs font-mono {{if eq .Value "enabled"}}text-green-400{{else if eq .Value "disabled"}}text-muted-foreground{{else if eq .Value "********"}}text-muted-foreground/50{{else}}text-foreground{{end}}">{{.Value}}</span>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Audit Log -->
<div class="bg-card rounded-lg border border-border">
    <div class="px-4 py-3 border-b border-border">
        <h2 class="text-sm font-medium text-foreground">Audit Log</h2>
        <p class="text-xs text-muted-foreground">Last 50 events</p>
    </div>
    {{if .AuditLogs}}
    <div class="overflow-x-auto max-h-[32rem] overflow-y-auto">
        <table class="w-full">
            <thead class="sticky top-0 bg-card">
                <tr class="border-b border-border">
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Time</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Action</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">User</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider hidden sm:table-cell">IP Address</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider hidden md:table-cell">Details</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border/50">
                {{range .AuditLogs}}
                <tr class="hover:bg-card-elevated transition-smooth">
                    <td class="px-4 py-2.5 text-xs text-muted-foreground whitespace-nowrap">{{timeago .CreatedAt}}</td>
                    <td class="px-4 py-2.5">
                        {{$action := print .Action}}
                        <span class="px-2 py-0.5 text-[10px] font-medium rounded
                            {{if eq $action "login_success"}}bg-green-500/20 text-green-400
                            {{else if eq $action "login_failed"}}bg-red-500/20 text-red-400
                            {{else if hasSuffix $action "_created"}}bg-blue-500/20 text-blue-400
                            {{else if hasSuffix $action "_updated"}}bg-yellow-500/20 text-yellow-400
                            {{else if hasSuffix $action "_deleted"}}bg-red-500/20 text-red-400
                            {{else if hasSuffix $action "_revoked"}}bg-red-500/20 text-red-400
                            {{else if hasPrefix $action "incident_"}}bg-orange-500/20 text-orange-400
                            {{else}}bg-muted text-muted-foreground
                            {{end}}">{{$action}}</span>
                    </td>
                    <td class="px-4 py-2.5 text-xs text-foreground">{{if .Email}}{{.Email}}{{else}}&mdash;{{end}}</td>
                    <td class="px-4 py-2.5 text-xs text-muted-foreground font-mono hidden sm:table-cell">{{if .IPAddress}}{{.IPAddress}}{{else}}&mdash;{{end}}</td>
                    <td class="px-4 py-2.5 text-xs text-muted-foreground hidden md:table-cell">
                        {{if .Metadata}}
                        {{range $k, $v := .Metadata}}
                        <span class="inline-block mr-2"><span class="text-muted-foreground/70">{{$k}}:</span> {{$v}}</span>
                        {{end}}
                        {{else}}
                        &mdash;
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="px-4 py-8 text-center text-sm text-muted-foreground">No audit log entries yet.</div>
    {{end}}
</div>
{{end}}
