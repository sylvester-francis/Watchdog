{{define "admin.html"}}
{{template "base" .}}
{{end}}

{{define "content"}}
<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <!-- Total Users -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Total Users</p>
        <p class="text-xl font-semibold text-foreground mt-1">{{.TotalUsers}}</p>
    </div>

    <!-- Plan Breakdown -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider mb-2">Plan Breakdown</p>
        <div class="flex items-center space-x-2">
            <span class="px-2 py-0.5 text-xs rounded bg-muted text-muted-foreground">Free: {{.PlanFree}}</span>
            <span class="px-2 py-0.5 text-xs rounded bg-blue-500/20 text-blue-400">Pro: {{.PlanPro}}</span>
            <span class="px-2 py-0.5 text-xs rounded bg-muted text-muted-foreground">Team: {{.PlanTeam}}</span>
        </div>
    </div>

    <!-- Limit Hits (24h) -->
    <div class="bg-card rounded-lg border border-border px-4 py-3">
        <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Limit Hits (24h)</p>
        <p class="text-xl font-semibold {{if gt .LimitHitCount 0}}text-red-400{{else}}text-foreground{{end}} mt-1">{{.LimitHitCount}}</p>
    </div>
</div>

<!-- Upgrade Candidates -->
<div class="bg-card rounded-lg border border-border mb-6">
    <div class="px-4 py-3 border-b border-border">
        <h2 class="text-sm font-medium text-foreground">Upgrade Candidates</h2>
        <p class="text-xs text-muted-foreground">Users at 80%+ of their plan limits</p>
    </div>
    {{if .NearLimitUsers}}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-border">
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Email</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Plan</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Agents</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Monitors</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border/50">
                {{range .NearLimitUsers}}
                <tr class="hover:bg-card-elevated transition-smooth">
                    <td class="px-4 py-3 text-sm text-foreground">{{.Email}}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-0.5 text-xs rounded
                            {{if eq .Plan.String "Pro"}}bg-blue-500/20 text-blue-400
                            {{else}}bg-muted text-muted-foreground{{end}}">
                            {{.Plan.String}}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">{{.AgentCount}} / {{.AgentMax}}</td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">
                        {{.MonitorCount}} / {{if eq .MonitorMax -1}}Unlimited{{else}}{{.MonitorMax}}{{end}}
                    </td>
                    <td class="px-4 py-3">
                        {{if or (ge .AgentCount .AgentMax) (and (ne .MonitorMax -1) (ge .MonitorCount .MonitorMax))}}
                        <span class="px-2 py-0.5 text-xs rounded bg-red-500/20 text-red-400">At Limit</span>
                        {{else}}
                        <span class="px-2 py-0.5 text-xs rounded bg-yellow-500/20 text-yellow-400">Near Limit</span>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="px-4 py-8 text-center text-sm text-muted-foreground">No users near their limits.</div>
    {{end}}
</div>

<!-- Recent Events -->
<div class="bg-card rounded-lg border border-border">
    <div class="px-4 py-3 border-b border-border">
        <h2 class="text-sm font-medium text-foreground">Recent Usage Events</h2>
        <p class="text-xs text-muted-foreground">Last 50 limit-related events</p>
    </div>
    {{if .RecentEvents}}
    <div class="overflow-x-auto max-h-96 overflow-y-auto">
        <table class="w-full">
            <thead class="sticky top-0 bg-card">
                <tr class="border-b border-border">
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Time</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Event</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Resource</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Count / Max</th>
                    <th class="px-4 py-3 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Plan</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border/50">
                {{range .RecentEvents}}
                <tr class="hover:bg-card-elevated transition-smooth">
                    <td class="px-4 py-3 text-sm text-muted-foreground">{{formatTimeAgo .CreatedAt}}</td>
                    <td class="px-4 py-3">
                        {{if eq (print .EventType) "limit_hit"}}
                        <span class="px-2 py-0.5 text-xs rounded bg-red-500/20 text-red-400">Limit Hit</span>
                        {{else}}
                        <span class="px-2 py-0.5 text-xs rounded bg-yellow-500/20 text-yellow-400">Approaching</span>
                        {{end}}
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground capitalize">{{.ResourceType}}</td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">{{.CurrentCount}} / {{.MaxAllowed}}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-0.5 text-xs rounded
                            {{if eq .Plan.String "Pro"}}bg-blue-500/20 text-blue-400
                            {{else}}bg-muted text-muted-foreground{{end}}">
                            {{.Plan.String}}
                        </span>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="px-4 py-8 text-center text-sm text-muted-foreground">No usage events yet.</div>
    {{end}}
</div>
{{end}}
