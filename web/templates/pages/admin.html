{{define "admin.html"}}
{{template "base" .}}
{{end}}

{{define "content"}}
<!-- System Health -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <!-- Database -->
    <div class="bg-card rounded-lg border border-border p-3">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Database</p>
            <div class="w-6 h-6 rounded flex items-center justify-center {{if .DBHealthy}}bg-emerald-500/10{{else}}bg-red-500/10{{end}}">
                <i data-lucide="database" class="w-3 h-3 {{if .DBHealthy}}text-emerald-400{{else}}text-red-400{{end}}"></i>
            </div>
        </div>
        <p class="text-2xl font-semibold text-foreground font-mono tracking-tight">{{.PingLatency}}</p>
        <p class="text-xs text-muted-foreground mt-1">{{if .DBHealthy}}Healthy{{else}}Unreachable{{end}} &middot; ping latency</p>
    </div>

    <!-- Connection Pool -->
    <div class="bg-card rounded-lg border border-border p-3">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Connection Pool</p>
            <div class="w-6 h-6 bg-muted/50 rounded flex items-center justify-center">
                <i data-lucide="layers" class="w-3 h-3 text-muted-foreground"></i>
            </div>
        </div>
        <p class="text-2xl font-semibold text-foreground font-mono tracking-tight">{{.PoolAcquired}} <span class="text-sm font-normal text-muted-foreground">/ {{.PoolTotal}}</span></p>
        <p class="text-xs text-muted-foreground mt-1">{{.PoolIdle}} idle connections</p>
    </div>

    <!-- Connected Agents -->
    <div class="bg-card rounded-lg border border-border p-3">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Connected Agents</p>
            <div class="w-6 h-6 {{if gt .AgentCount 0}}bg-emerald-500/10{{else}}bg-muted/50{{end}} rounded flex items-center justify-center">
                <i data-lucide="server" class="w-3 h-3 {{if gt .AgentCount 0}}text-emerald-400{{else}}text-muted-foreground{{end}}"></i>
            </div>
        </div>
        <p class="text-2xl font-semibold text-foreground font-mono tracking-tight">{{.AgentCount}}</p>
        <p class="text-xs text-muted-foreground mt-1">Active WebSocket connections</p>
    </div>

    <!-- Uptime -->
    <div class="bg-card rounded-lg border border-border p-3">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Uptime</p>
            <div class="w-6 h-6 bg-muted/50 rounded flex items-center justify-center">
                <i data-lucide="clock" class="w-3 h-3 text-muted-foreground"></i>
            </div>
        </div>
        <p class="text-2xl font-semibold text-foreground font-mono tracking-tight">{{.Uptime}}</p>
        <p class="text-xs text-muted-foreground mt-1">Since last restart</p>
    </div>
</div>

<!-- Migration Status + Config Overview -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <!-- Migration Status -->
    <div class="bg-card rounded-lg border border-border">
        <div class="px-4 py-3 border-b border-border flex items-center space-x-2">
            <div class="w-6 h-6 bg-muted/50 rounded flex items-center justify-center">
                <i data-lucide="arrow-up-circle" class="w-3 h-3 text-muted-foreground"></i>
            </div>
            <h2 class="text-sm font-medium text-foreground">Migration Status</h2>
        </div>
        <div class="px-4 py-3">
            <div class="flex items-center justify-between py-2">
                <span class="text-xs text-muted-foreground">Current Version</span>
                <span class="text-sm font-medium text-foreground font-mono">{{.Migration.Version}}</span>
            </div>
            <div class="border-t border-border/30"></div>
            <div class="flex items-center justify-between py-2">
                <span class="text-xs text-muted-foreground">Dirty</span>
                {{if .Migration.Dirty}}
                <span class="px-2 py-0.5 text-[10px] font-medium rounded bg-red-500/15 text-red-400">Yes</span>
                {{else}}
                <span class="px-2 py-0.5 text-[10px] font-medium rounded bg-green-500/15 text-green-400">No</span>
                {{end}}
            </div>
            <div class="border-t border-border/30"></div>
            <div class="flex items-center justify-between py-2">
                <span class="text-xs text-muted-foreground">Total Applied</span>
                <span class="text-sm font-medium text-foreground font-mono">{{.TotalMigrations}}</span>
            </div>
        </div>
    </div>

    <!-- Config Overview -->
    <div class="bg-card rounded-lg border border-border">
        <div class="px-4 py-3 border-b border-border flex items-center space-x-2">
            <div class="w-6 h-6 bg-muted/50 rounded flex items-center justify-center">
                <i data-lucide="sliders-horizontal" class="w-3 h-3 text-muted-foreground"></i>
            </div>
            <h2 class="text-sm font-medium text-foreground">Config Overview</h2>
        </div>
        <div class="px-4 py-2 max-h-80 overflow-y-auto">
            {{range $i, $section := .ConfigSections}}
            {{if $i}}<div class="border-t border-border/30 my-1"></div>{{end}}
            <div class="py-1">
                <p class="text-[10px] font-medium text-muted-foreground uppercase tracking-wider py-1.5">{{.Name}}</p>
                {{range .Entries}}
                <div class="flex items-center justify-between py-1.5 min-h-[28px]">
                    <span class="text-xs text-muted-foreground">{{.Key}}</span>
                    <span class="text-xs font-mono text-right ml-4 {{if eq .Value "enabled"}}text-green-400{{else if eq .Value "disabled"}}text-muted-foreground/50{{else if eq .Value "********"}}text-muted-foreground/30{{else}}text-foreground{{end}}">{{.Value}}</span>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Audit Log -->
<div class="bg-card rounded-lg border border-border">
    <div class="px-4 py-3 border-b border-border flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <div class="w-6 h-6 bg-muted/50 rounded flex items-center justify-center">
                <i data-lucide="scroll-text" class="w-3 h-3 text-muted-foreground"></i>
            </div>
            <div>
                <h2 class="text-sm font-medium text-foreground">Audit Log</h2>
            </div>
        </div>
        <span class="text-[10px] text-muted-foreground font-mono">Last 50 events</span>
    </div>
    {{if .AuditLogs}}
    <div class="overflow-x-auto max-h-[32rem] overflow-y-auto">
        <table class="w-full">
            <thead class="sticky top-0 bg-card z-10">
                <tr class="border-b border-border">
                    <th class="px-4 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider w-24">Time</th>
                    <th class="px-4 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Action</th>
                    <th class="px-4 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">User</th>
                    <th class="px-4 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider hidden sm:table-cell w-32">IP Address</th>
                    <th class="px-4 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider hidden md:table-cell">Details</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border/30">
                {{range .AuditLogs}}
                <tr class="hover:bg-muted/20 transition-colors">
                    <td class="px-4 py-2.5 text-xs text-muted-foreground whitespace-nowrap font-mono">{{timeago .CreatedAt}}</td>
                    <td class="px-4 py-2.5">
                        {{$action := print .Action}}
                        <span class="px-2 py-0.5 text-[10px] font-medium rounded whitespace-nowrap
                            {{if eq $action "login_success"}}bg-green-500/15 text-green-400
                            {{else if eq $action "login_failed"}}bg-red-500/15 text-red-400
                            {{else if hasSuffix $action "_created"}}bg-blue-500/15 text-blue-400
                            {{else if hasSuffix $action "_updated"}}bg-yellow-500/15 text-yellow-400
                            {{else if hasSuffix $action "_deleted"}}bg-red-500/15 text-red-400
                            {{else if hasSuffix $action "_revoked"}}bg-red-500/15 text-red-400
                            {{else if hasPrefix $action "incident_"}}bg-orange-500/15 text-orange-400
                            {{else}}bg-muted text-muted-foreground
                            {{end}}">{{$action}}</span>
                    </td>
                    <td class="px-4 py-2.5 text-xs text-foreground">{{if .Email}}{{.Email}}{{else}}<span class="text-muted-foreground/40">&mdash;</span>{{end}}</td>
                    <td class="px-4 py-2.5 text-xs text-muted-foreground font-mono hidden sm:table-cell">{{if .IPAddress}}{{.IPAddress}}{{else}}<span class="text-muted-foreground/40">&mdash;</span>{{end}}</td>
                    <td class="px-4 py-2.5 text-xs text-muted-foreground hidden md:table-cell max-w-xs truncate">
                        {{if .Metadata}}
                        {{range $k, $v := .Metadata}}
                        <span class="inline-block mr-2"><span class="text-muted-foreground/50">{{$k}}:</span> {{$v}}</span>
                        {{end}}
                        {{else}}
                        <span class="text-muted-foreground/40">&mdash;</span>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="text-center py-12">
        <div class="w-12 h-12 rounded-full bg-muted/50 flex items-center justify-center mx-auto mb-3">
            <i data-lucide="scroll-text" class="w-6 h-6 text-muted-foreground/40"></i>
        </div>
        <p class="text-sm text-muted-foreground font-medium">No audit log entries yet</p>
        <p class="text-xs text-muted-foreground/60 mt-1">Events will appear here as users interact with the system.</p>
    </div>
    {{end}}
</div>
{{end}}
