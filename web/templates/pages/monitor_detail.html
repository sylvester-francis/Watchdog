{{define "monitor_detail.html"}}
{{template "base" .}}
{{end}}

{{define "content"}}
<div class="animate-fade-in-up">
    <!-- Breadcrumb + Back -->
    <div class="flex items-center space-x-2 mb-6">
        <a href="/monitors" class="text-xs text-muted-foreground hover:text-foreground transition-smooth flex items-center space-x-1">
            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
            <span>Monitors</span>
        </a>
        <span class="text-xs text-muted-foreground">/</span>
        <span class="text-xs text-foreground">{{.Monitor.Name}}</span>
    </div>

    <!-- Monitor Header -->
    <div class="bg-card border border-border rounded-lg p-5 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-lg {{if eq (print .Monitor.Status) "up"}}bg-emerald-500/10{{else if eq (print .Monitor.Status) "down"}}bg-red-500/10{{else}}bg-muted/50{{end}} flex items-center justify-center">
                    <div class="w-3 h-3 rounded-full {{statusBgColor (print .Monitor.Status)}} {{if eq (print .Monitor.Status) "up"}}animate-pulse-dot{{end}}" aria-label="Status: {{.Monitor.Status}}"></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-foreground">{{.Monitor.Name}}</h2>
                    <div class="flex items-center space-x-3 mt-1">
                        <span class="text-[10px] px-2 py-0.5 rounded-md bg-muted text-muted-foreground uppercase font-mono">{{.Monitor.Type}}</span>
                        <span class="text-xs text-muted-foreground font-mono">{{.Monitor.Target}}</span>
                    </div>
                </div>
            </div>
            <span class="text-sm font-medium {{statusColor (print .Monitor.Status)}}">{{.Monitor.Status}}</span>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
        <div class="bg-card border border-border rounded-lg p-4">
            <div class="flex items-center space-x-1.5 mb-1">
                <i data-lucide="clock" class="w-3 h-3 text-muted-foreground"></i>
                <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider">Interval</p>
            </div>
            <p class="text-lg font-semibold text-foreground font-mono">{{.Monitor.IntervalSeconds}}s</p>
        </div>
        <div class="bg-card border border-border rounded-lg p-4">
            <div class="flex items-center space-x-1.5 mb-1">
                <i data-lucide="timer" class="w-3 h-3 text-muted-foreground"></i>
                <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider">Timeout</p>
            </div>
            <p class="text-lg font-semibold text-foreground font-mono">{{.Monitor.TimeoutSeconds}}s</p>
        </div>
        <div class="bg-card border border-border rounded-lg p-4">
            {{if eq (print .Monitor.Type) "system"}}
            <div class="flex items-center space-x-1.5 mb-1">
                <i data-lucide="gauge" class="w-3 h-3 text-muted-foreground"></i>
                <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider">Current</p>
            </div>
            {{if .MetricValues}}
            {{$last := index .MetricValues (sub (len .MetricValues) 1)}}
            <p class="text-lg font-semibold font-mono {{if eq (print .Monitor.Status) "down"}}text-red-400{{else}}text-emerald-400{{end}}">{{printf "%.1f" $last}}%</p>
            {{else}}
            <p class="text-lg font-semibold text-muted-foreground font-mono">--</p>
            {{end}}
            {{else}}
            <div class="flex items-center space-x-1.5 mb-1">
                <i data-lucide="trending-up" class="w-3 h-3 text-muted-foreground"></i>
                <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider">Uptime</p>
            </div>
            {{if gt .UptimeTotal 0}}
            <p class="text-lg font-semibold text-foreground font-mono">{{formatPercent .UptimePercent}}%</p>
            {{else}}
            <p class="text-lg font-semibold text-muted-foreground font-mono">--</p>
            {{end}}
            {{end}}
        </div>
        <div class="bg-card border border-border rounded-lg p-4">
            <div class="flex items-center space-x-1.5 mb-1">
                <i data-lucide="server" class="w-3 h-3 text-muted-foreground"></i>
                <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider">Agent</p>
            </div>
            <p class="text-sm font-medium text-foreground truncate">{{if .Agent}}{{.Agent.Name}}{{else}}Unknown{{end}}</p>
        </div>
    </div>

    <!-- TLS Certificate Info (shown only for TLS monitors with cert data) -->
    {{if and (eq (print .Monitor.Type) "tls") .CertExpiryDays}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="shield-check" class="w-4 h-4 text-muted-foreground"></i>
            <h3 class="text-sm font-medium text-foreground">TLS Certificate</h3>
        </div>
        <div class="px-5 py-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Days Until Expiry</p>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full {{if gt (deref .CertExpiryDays) 30}}bg-emerald-400{{else if gt (deref .CertExpiryDays) 14}}bg-yellow-400{{else if gt (deref .CertExpiryDays) 7}}bg-orange-400{{else}}bg-red-400{{end}}"></div>
                        <span class="text-lg font-semibold font-mono {{if gt (deref .CertExpiryDays) 30}}text-emerald-400{{else if gt (deref .CertExpiryDays) 14}}text-yellow-400{{else if gt (deref .CertExpiryDays) 7}}text-orange-400{{else}}text-red-400{{end}}">{{deref .CertExpiryDays}} days</span>
                    </div>
                </div>
                {{if .CertIssuer}}
                <div>
                    <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Issuer</p>
                    <span class="text-sm text-foreground font-mono">{{deref .CertIssuer}}</span>
                </div>
                {{end}}
            </div>
        </div>
    </div>
    {{end}}

    <!-- Docker Info (shown only for docker monitors) -->
    {{if eq (print .Monitor.Type) "docker"}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="container" class="w-4 h-4 text-muted-foreground"></i>
            <h3 class="text-sm font-medium text-foreground">Docker Container</h3>
        </div>
        <div class="px-5 py-4">
            <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Container</p>
            <span class="text-sm text-foreground font-mono">{{.Monitor.Target}}</span>
        </div>
    </div>
    {{end}}

    <!-- Database Info (shown only for database monitors) -->
    {{if eq (print .Monitor.Type) "database"}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="database" class="w-4 h-4 text-muted-foreground"></i>
            <h3 class="text-sm font-medium text-foreground">Database</h3>
        </div>
        <div class="px-5 py-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {{if index .Monitor.Metadata "db_type"}}
                <div>
                    <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Database Type</p>
                    <span class="text-sm text-foreground font-mono uppercase">{{index .Monitor.Metadata "db_type"}}</span>
                </div>
                {{end}}
                <div>
                    <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Target</p>
                    <span class="text-sm text-foreground font-mono">{{.Monitor.Target}}</span>
                </div>
            </div>
        </div>
    </div>
    {{end}}

    <!-- System Metrics Info (shown only for system monitors) -->
    {{if eq (print .Monitor.Type) "system"}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="cpu" class="w-4 h-4 text-muted-foreground"></i>
            <h3 class="text-sm font-medium text-foreground">System Metrics</h3>
        </div>
        <div class="px-5 py-4">
            <p class="text-[11px] font-medium text-muted-foreground uppercase tracking-wider mb-1">Metric &amp; Threshold</p>
            <span class="text-sm text-foreground font-mono">{{.Monitor.Target}}</span>
        </div>
    </div>
    {{end}}

    <!-- Metric Usage Chart (system monitors only) -->
    {{if eq (print .Monitor.Type) "system"}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="bar-chart-3" class="w-4 h-4 text-accent"></i>
            <h3 class="text-sm font-medium text-foreground">{{.MetricName}} Usage (Last 20 checks)</h3>
        </div>
        <div class="p-5">
            {{if .MetricValues}}
            <div class="h-56" id="detail-metric-container">
                <canvas id="detail-metric-chart"></canvas>
            </div>
            {{else}}
            <div class="h-56 flex items-center justify-center">
                <div class="text-center">
                    <i data-lucide="bar-chart-3" class="w-8 h-8 text-muted-foreground/20 mx-auto mb-2"></i>
                    <p class="text-xs text-muted-foreground">Collecting metric data...</p>
                    <p class="text-[10px] text-muted-foreground/50 mt-1">Chart will appear after the next few checks</p>
                </div>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Latency Chart (hidden for system/docker â€” no meaningful latency) -->
    {{if and (ne (print .Monitor.Type) "system") (ne (print .Monitor.Type) "docker")}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i data-lucide="timer" class="w-4 h-4 text-accent"></i>
                <h3 class="text-sm font-medium text-foreground">Response Time</h3>
            </div>
            <div class="flex items-center space-x-1" id="period-selector">
                <button data-period="1h" class="px-2 py-1 text-[10px] font-medium rounded transition-colors text-muted-foreground hover:text-foreground hover:bg-muted/50">1H</button>
                <button data-period="24h" class="px-2 py-1 text-[10px] font-medium rounded transition-colors bg-accent/15 text-accent">24H</button>
                <button data-period="7d" class="px-2 py-1 text-[10px] font-medium rounded transition-colors text-muted-foreground hover:text-foreground hover:bg-muted/50">7D</button>
                <button data-period="30d" class="px-2 py-1 text-[10px] font-medium rounded transition-colors text-muted-foreground hover:text-foreground hover:bg-muted/50">30D</button>
            </div>
        </div>
        <div class="p-5">
            <div class="h-56" id="detail-chart-container">
                <canvas id="detail-latency-chart"></canvas>
            </div>
            <div class="h-56 flex items-center justify-center" id="detail-chart-empty" style="display:none">
                <div class="text-center">
                    <i data-lucide="bar-chart-3" class="w-8 h-8 text-muted-foreground/20 mx-auto mb-2"></i>
                    <p class="text-xs text-muted-foreground">No latency data for this period</p>
                </div>
            </div>
            <div class="h-56 flex items-center justify-center" id="detail-chart-loading" style="display:none">
                <div class="text-center">
                    <div class="w-5 h-5 border-2 border-accent/30 border-t-accent rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-xs text-muted-foreground">Loading chart data...</p>
                </div>
            </div>
        </div>
    </div>
    {{end}}

    <!-- Uptime / Health Bar -->
    {{if gt .UptimeTotal 0}}
    <div class="bg-card border border-border rounded-lg mb-6">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="heart-pulse" class="w-4 h-4 text-accent"></i>
            <h3 class="text-sm font-medium text-foreground">{{if eq (print .Monitor.Type) "system"}}Health{{else}}Uptime{{end}} (Last 20 checks)</h3>
        </div>
        <div class="px-5 py-4">
            <div class="flex items-center space-x-4 mb-3">
                <div class="flex items-center space-x-1.5">
                    <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
                    <span class="text-[10px] text-muted-foreground font-mono">{{.UptimeUp}} success</span>
                </div>
                <div class="flex items-center space-x-1.5">
                    <div class="w-2 h-2 rounded-full bg-red-400"></div>
                    <span class="text-[10px] text-muted-foreground font-mono">{{.UptimeDown}} failed</span>
                </div>
            </div>
            <div class="w-full h-3 bg-muted rounded-full overflow-hidden flex gap-px">
                {{if gt .UptimeUp 0}}
                <div class="bg-emerald-500 h-full rounded-sm" style="width: calc({{.UptimeUp}} / {{.UptimeTotal}} * 100%)"></div>
                {{end}}
                {{if gt .UptimeDown 0}}
                <div class="bg-red-500 h-full rounded-sm" style="width: calc({{.UptimeDown}} / {{.UptimeTotal}} * 100%)"></div>
                {{end}}
            </div>
        </div>
    </div>
    {{end}}

    <!-- Recent Heartbeats -->
    {{if .Heartbeats}}
    <div class="bg-card border border-border rounded-lg">
        <div class="px-5 py-3.5 border-b border-border flex items-center space-x-2">
            <i data-lucide="list" class="w-4 h-4 text-accent"></i>
            <h3 class="text-sm font-medium text-foreground">Recent Checks</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-border">
                        <th class="px-5 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Time</th>
                        <th class="px-5 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">Status</th>
                        <th class="px-5 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">{{if eq (print $.Monitor.Type) "system"}}Value{{else if eq (print $.Monitor.Type) "docker"}}State{{else}}Latency{{end}}</th>
                        <th class="px-5 py-2.5 text-left text-[10px] font-medium text-muted-foreground uppercase tracking-wider">{{if eq (print $.Monitor.Type) "system"}}Message{{else if eq (print $.Monitor.Type) "docker"}}Details{{else}}Error{{end}}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border/30">
                    {{range .Heartbeats}}
                    <tr class="hover:bg-card-elevated transition-smooth">
                        <td class="px-5 py-2.5">
                            <span class="text-xs text-muted-foreground font-mono">{{formatTime .Time}}</span>
                        </td>
                        <td class="px-5 py-2.5">
                            <div class="flex items-center space-x-2">
                                <div class="w-1.5 h-1.5 rounded-full {{if .Status.IsSuccess}}bg-emerald-400{{else}}bg-red-400{{end}}"></div>
                                <span class="text-xs font-mono {{if .Status.IsSuccess}}text-emerald-400{{else}}text-red-400{{end}}">{{.Status}}</span>
                            </div>
                        </td>
                        <td class="px-5 py-2.5">
                            {{if eq (print $.Monitor.Type) "system"}}
                            {{if .ErrorMessage}}
                            <span class="text-xs text-foreground font-mono">{{.ErrorMessage}}</span>
                            {{else}}
                            <span class="text-xs text-muted-foreground">--</span>
                            {{end}}
                            {{else if eq (print $.Monitor.Type) "docker"}}
                            <span class="text-xs font-mono {{if .Status.IsSuccess}}text-emerald-400{{else}}text-red-400{{end}}">{{if .Status.IsSuccess}}Running{{else}}Stopped{{end}}</span>
                            {{else}}
                            {{if .LatencyMs}}
                            <span class="text-xs text-foreground font-mono">{{.LatencyMs}}ms</span>
                            {{else}}
                            <span class="text-xs text-muted-foreground">--</span>
                            {{end}}
                            {{end}}
                        </td>
                        <td class="px-5 py-2.5">
                            {{if eq (print $.Monitor.Type) "system"}}
                            {{if not .Status.IsSuccess}}
                            <span class="text-xs text-red-400 truncate max-w-[300px] block" title="{{deref .ErrorMessage}}">Threshold exceeded</span>
                            {{else}}
                            <span class="text-xs text-emerald-400">OK</span>
                            {{end}}
                            {{else if eq (print $.Monitor.Type) "docker"}}
                            {{if .ErrorMessage}}
                            <span class="text-xs text-red-400 truncate max-w-[300px] block" title="{{.ErrorMessage}}">{{.ErrorMessage}}</span>
                            {{else}}
                            <span class="text-xs text-emerald-400">Healthy</span>
                            {{end}}
                            {{else}}
                            {{if .ErrorMessage}}
                            <span class="text-xs text-red-400 truncate max-w-[300px] block" title="{{.ErrorMessage}}">{{.ErrorMessage}}</span>
                            {{else}}
                            <span class="text-xs text-muted-foreground">--</span>
                            {{end}}
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
    {{end}}

    <!-- Danger Zone -->
    <div class="bg-card border border-destructive/20 rounded-lg mt-6">
        <div class="px-5 py-3.5 border-b border-destructive/20">
            <h3 class="text-sm font-medium text-destructive">Danger Zone</h3>
        </div>
        <div class="px-5 py-4 flex items-center justify-between">
            <div>
                <p class="text-sm text-foreground">Delete this monitor</p>
                <p class="text-xs text-muted-foreground mt-0.5">Permanently remove this monitor and all its data. This action cannot be undone.</p>
            </div>
            <button hx-delete="/monitors/{{.Monitor.ID}}" hx-confirm="Are you sure you want to delete '{{.Monitor.Name}}'? This cannot be undone."
                class="px-3 py-1.5 text-xs font-medium text-destructive border border-destructive/30 hover:bg-destructive/10 rounded-md transition-smooth shrink-0 ml-4"
                aria-label="Delete monitor {{.Monitor.Name}}">
                <i data-lucide="trash-2" class="w-3.5 h-3.5 inline-block mr-1"></i>
                Delete Monitor
            </button>
        </div>
    </div>
</div>

{{if and (ne (print .Monitor.Type) "system") (ne (print .Monitor.Type) "docker")}}
<script nonce="{{.Nonce}}">
(function() {
    var monitorID = '{{.Monitor.ID}}';
    var currentChart = null;
    var chartContainer = document.getElementById('detail-chart-container');
    var emptyState = document.getElementById('detail-chart-empty');
    var loadingState = document.getElementById('detail-chart-loading');

    function showState(state) {
        chartContainer.style.display = state === 'chart' ? '' : 'none';
        emptyState.style.display = state === 'empty' ? '' : 'none';
        loadingState.style.display = state === 'loading' ? '' : 'none';
    }

    function loadPeriod(period) {
        showState('loading');
        if (currentChart) {
            currentChart.destroy();
            currentChart = null;
        }

        fetch('/api/monitors/' + monitorID + '/latency?period=' + period)
            .then(function(resp) { return resp.json(); })
            .then(function(points) {
                if (!points || points.length === 0) {
                    showState('empty');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }
                showState('chart');
                currentChart = createTimeLatencyChart('detail-latency-chart', points);
            })
            .catch(function() { showState('empty'); });
    }

    // Period selector click handler
    var selector = document.getElementById('period-selector');
    if (selector) {
        var buttons = selector.querySelectorAll('button');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].addEventListener('click', function() {
                for (var j = 0; j < buttons.length; j++) {
                    buttons[j].className = 'px-2 py-1 text-[10px] font-medium rounded transition-colors text-muted-foreground hover:text-foreground hover:bg-muted/50';
                }
                this.className = 'px-2 py-1 text-[10px] font-medium rounded transition-colors bg-accent/15 text-accent';
                loadPeriod(this.dataset.period);
            });
        }
    }

    // Load default period (24h) on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPeriod('24h');
    });
})();
</script>
{{end}}

{{if and (eq (print .Monitor.Type) "system") .MetricValues}}
<script type="application/json" id="detail-metric-data">{"values":{{toJSON .MetricValues}},"threshold":{{.MetricThreshold}},"metric":"{{.MetricName}}"}</script>
<script nonce="{{.Nonce}}">
document.addEventListener('DOMContentLoaded', function() {
    var el = document.getElementById('detail-metric-data');
    if (!el) return;
    try {
        var data = JSON.parse(el.textContent);
        if (data.values && data.values.length > 0) {
            var labels = data.values.map(function(_, idx) { return idx + 1; });
            createMetricChart('detail-metric-chart', labels, data.values, data.threshold, data.metric);
        }
    } catch(e) {}
});
</script>
{{end}}
{{end}}
