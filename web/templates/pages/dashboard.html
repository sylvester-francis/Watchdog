{{define "dashboard.html"}}
{{template "base" .}}
{{end}}

{{define "content"}}
<!-- Fleet Status Banner -->
<div class="bg-card border border-border rounded-lg mb-4 overflow-hidden">
    <div class="flex items-stretch">
        <!-- Accent bar (thicker) -->
        <div class="w-[3px] shrink-0 {{if and (eq .Stats.MonitorsDown 0) (gt .Stats.TotalMonitors 0)}}bg-emerald-500{{else if gt .Stats.MonitorsDown 0}}bg-red-500{{else}}bg-muted{{end}}"></div>

        <div class="flex-1 px-4 py-3.5">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                {{if gt .Stats.TotalMonitors 0}}
                <!-- Hero uptime number on left -->
                <div class="flex items-center space-x-4">
                    <span class="text-stat font-mono tracking-tight {{if ge .Stats.UptimePercent 99.0}}text-emerald-400{{else if ge .Stats.UptimePercent 95.0}}text-amber-400{{else}}text-red-400{{end}}">{{formatPercent .Stats.UptimePercent}}<span class="text-base font-semibold text-muted-foreground">%</span></span>
                    <div>
                        <h2 class="text-sm font-medium text-foreground">
                            {{if eq .Stats.MonitorsDown 0}}All systems operational
                            {{else}}{{.Stats.MonitorsDown}} system{{if gt .Stats.MonitorsDown 1}}s{{end}} degraded
                            {{end}}
                        </h2>
                        <p class="text-xs text-muted-foreground mt-0.5">
                            {{.Stats.MonitorsUp}} of {{.Stats.TotalMonitors}} monitors healthy &middot; Last 24 hours
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-1.5">
                    <span class="text-xs font-mono px-1.5 py-0.5 rounded bg-emerald-500/15 text-emerald-400">{{.Stats.MonitorsUp}} up</span>
                    {{if gt .Stats.MonitorsDown 0}}
                    <span class="text-xs font-mono px-1.5 py-0.5 rounded bg-red-500/15 text-red-400">{{.Stats.MonitorsDown}} dn</span>
                    {{end}}
                </div>
                {{else}}
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-md bg-muted/50 flex items-center justify-center shrink-0">
                        <i data-lucide="minus-circle" class="w-4 h-4 text-muted-foreground"></i>
                    </div>
                    <div>
                        <h2 class="text-sm font-medium text-foreground">No monitors configured</h2>
                        <p class="text-xs text-muted-foreground mt-0.5">Deploy an agent and create monitors to get started</p>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
    <div class="bg-card border border-border rounded-lg p-3 border-l-[3px] border-l-muted">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Monitors</p>
            <div class="w-6 h-6 bg-muted/50 rounded flex items-center justify-center">
                <i data-lucide="activity" class="w-3 h-3 text-muted-foreground"></i>
            </div>
        </div>
        <p class="text-stat text-foreground font-mono" data-count-target="{{.Stats.TotalMonitors}}">0</p>
        <p class="text-xs text-muted-foreground mt-1">{{.Stats.MonitorsUp}} up &middot; {{.Stats.MonitorsDown}} down</p>
    </div>

    <div class="bg-card border border-border rounded-lg p-3 border-l-[3px] border-l-emerald-500">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Healthy</p>
            <div class="w-6 h-6 bg-emerald-500/10 rounded flex items-center justify-center">
                <i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-400"></i>
            </div>
        </div>
        <p class="text-stat text-emerald-400 font-mono" data-count-target="{{.Stats.MonitorsUp}}">0</p>
        {{if gt .Stats.TotalMonitors 0}}
        <p class="text-xs mt-1 {{if ge .Stats.UptimePercent 99.0}}text-emerald-400/70{{else if ge .Stats.UptimePercent 95.0}}text-amber-400/70{{else}}text-red-400/70{{end}}">{{formatPercent .Stats.UptimePercent}}% uptime (24h)</p>
        {{else}}
        <p class="text-xs text-muted-foreground mt-1">No checks yet</p>
        {{end}}
    </div>

    <div class="bg-card border {{if gt .Stats.MonitorsDown 0}}border-red-500/30{{else}}border-border{{end}} rounded-lg p-3 border-l-[3px] border-l-red-500">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Down</p>
            <div class="w-6 h-6 {{if gt .Stats.MonitorsDown 0}}bg-red-500/10{{else}}bg-muted/50{{end}} rounded flex items-center justify-center">
                <i data-lucide="x-circle" class="w-3 h-3 {{if gt .Stats.MonitorsDown 0}}text-red-400{{else}}text-muted-foreground{{end}}"></i>
            </div>
        </div>
        <p class="text-stat {{if gt .Stats.MonitorsDown 0}}text-red-400{{else}}text-foreground{{end}} font-mono" data-count-target="{{.Stats.MonitorsDown}}">0</p>
        <p class="text-xs text-muted-foreground mt-1">{{if gt .Stats.MonitorsDown 0}}Requires attention{{else}}All clear{{end}}</p>
    </div>

    <div class="bg-card border {{if gt .Stats.ActiveIncidents 0}}border-red-500/30{{else}}border-border{{end}} rounded-lg p-3 border-l-[3px] border-l-amber-500">
        <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-medium text-muted-foreground">Incidents</p>
            <div class="w-6 h-6 {{if gt .Stats.ActiveIncidents 0}}bg-amber-500/10{{else}}bg-muted/50{{end}} rounded flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-3 h-3 {{if gt .Stats.ActiveIncidents 0}}text-amber-400{{else}}text-muted-foreground{{end}}"></i>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <p class="text-stat {{if gt .Stats.ActiveIncidents 0}}text-red-400{{else}}text-foreground{{end}} font-mono" data-count-target="{{.Stats.ActiveIncidents}}">0</p>
            {{if gt .Stats.ActiveIncidents 0}}
            <span class="w-2 h-2 rounded-full bg-red-400 animate-pulse-dot"></span>
            {{end}}
        </div>
        <p class="text-xs text-muted-foreground mt-1">{{if gt .Stats.ActiveIncidents 0}}Active now{{else}}No open incidents{{end}}</p>
    </div>
</div>

<!-- Services (full width) -->
{{if .ServiceSparklines}}
<div class="bg-card border border-border rounded-lg mb-4">
    <div class="px-4 py-3 border-b border-border flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <i data-lucide="globe" class="w-4 h-4 text-muted-foreground"></i>
            <h2 class="text-sm font-medium text-foreground">Services</h2>
            <span class="text-[10px] text-muted-foreground font-mono">{{len .ServiceSparklines}}</span>
        </div>
        <a href="/monitors" class="text-xs text-muted-foreground hover:text-foreground transition-smooth flex items-center space-x-1">
            <span>View all</span>
            <i data-lucide="arrow-right" class="w-3 h-3"></i>
        </a>
    </div>

    <!-- Column Headers -->
    <div class="hidden sm:flex items-center px-4 py-2 border-b border-border/30 text-[9px] font-medium text-muted-foreground uppercase tracking-wider">
        <div class="w-5 shrink-0"></div>
        <div class="flex-1 min-w-0 ml-2">Service</div>
        <div class="w-36 shrink-0 text-center hidden md:block">Uptime (24h)</div>
        <div class="w-14 shrink-0 text-right hidden md:block ml-2">Uptime</div>
        <div class="w-16 shrink-0 text-right hidden md:block ml-3">Latency</div>
        <div class="w-14 shrink-0 text-right hidden md:block ml-2">Response</div>
        <div class="w-5 shrink-0"></div>
    </div>

    <!-- Service Rows -->
    <div class="divide-y divide-border/20">
        {{range .ServiceSparklines}}
        <a href="/monitors/{{.MonitorID}}" class="flex items-center px-4 py-3.5 hover:bg-card-elevated transition-smooth group">
            <div class="w-5 shrink-0 flex justify-center">
                <div class="w-2 h-2 rounded-full
                    {{if eq .Status "up"}}bg-emerald-400 animate-pulse-dot
                    {{else if eq .Status "down"}}bg-red-400
                    {{else}}bg-muted-foreground{{end}}" aria-label="Status: {{.Status}}"></div>
            </div>
            <div class="flex-1 min-w-0 ml-2">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-foreground truncate">{{.Name}}</span>
                    <span class="text-[9px] text-muted-foreground font-mono uppercase shrink-0 px-1.5 py-0.5 rounded bg-muted/50">{{.Type}}</span>
                </div>
                <p class="text-[10px] text-muted-foreground font-mono truncate mt-0.5 hidden sm:block">{{.Target}}</p>
            </div>
            <div class="w-36 shrink-0 hidden md:flex items-center justify-center space-x-px mx-2">
                {{if gt .UptimeTotal 0}}
                <div class="flex items-center space-x-px" id="checks-{{.MonitorID}}"></div>
                {{else}}
                <span class="text-[9px] text-muted-foreground">No data</span>
                {{end}}
            </div>
            <div class="w-14 shrink-0 hidden md:flex items-center justify-end ml-2">
                <span class="text-xs font-mono font-medium
                    {{if ge .UptimePercent 99.0}}text-emerald-400
                    {{else if ge .UptimePercent 95.0}}text-amber-400
                    {{else}}text-red-400{{end}}">{{formatPercent .UptimePercent}}%</span>
            </div>
            <div class="w-16 shrink-0 hidden md:flex items-center justify-end ml-3">
                {{if .Latencies}}
                <canvas id="spark-{{.MonitorID}}" class="w-14 h-5"></canvas>
                {{else}}
                <span class="text-[9px] text-muted-foreground">No data</span>
                {{end}}
            </div>
            <div class="w-14 shrink-0 hidden md:flex items-center justify-end ml-2">
                <span class="text-xs font-mono text-muted-foreground" id="resp-{{.MonitorID}}">--</span>
            </div>
            <div class="w-5 shrink-0 flex justify-end">
                <i data-lucide="chevron-right" class="w-3 h-3 text-muted-foreground/20 group-hover:text-muted-foreground transition-smooth"></i>
            </div>
        </a>
        {{end}}
    </div>
</div>
{{end}}

<!-- Infrastructure (full width) -->
{{if .InfraSparklines}}
<div class="bg-card border border-border rounded-lg mb-4">
    <div class="px-4 py-3 border-b border-border flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <i data-lucide="hard-drive" class="w-4 h-4 text-muted-foreground"></i>
            <h2 class="text-sm font-medium text-foreground">Infrastructure</h2>
            <span class="text-[10px] text-muted-foreground font-mono">{{len .InfraSparklines}}</span>
        </div>
        <a href="/monitors" class="text-xs text-muted-foreground hover:text-foreground transition-smooth flex items-center space-x-1">
            <span>View all</span>
            <i data-lucide="arrow-right" class="w-3 h-3"></i>
        </a>
    </div>

    <!-- Column Headers -->
    <div class="hidden sm:flex items-center px-4 py-2 border-b border-border/30 text-[9px] font-medium text-muted-foreground uppercase tracking-wider">
        <div class="w-5 shrink-0"></div>
        <div class="flex-1 min-w-0 ml-2">Service</div>
        <div class="w-36 shrink-0 text-center hidden md:block">Health (24h)</div>
        <div class="w-14 shrink-0 text-right hidden md:block ml-2">Uptime</div>
        <div class="w-20 shrink-0 text-right hidden md:block ml-3">Value</div>
        <div class="w-5 shrink-0"></div>
    </div>

    <!-- Infrastructure Rows -->
    <div class="divide-y divide-border/20">
        {{range .InfraSparklines}}
        <a href="/monitors/{{.MonitorID}}" class="flex items-center px-4 py-3.5 hover:bg-card-elevated transition-smooth group">
            <div class="w-5 shrink-0 flex justify-center">
                <div class="w-2 h-2 rounded-full
                    {{if eq .Status "up"}}bg-emerald-400 animate-pulse-dot
                    {{else if eq .Status "down"}}bg-red-400
                    {{else}}bg-muted-foreground{{end}}" aria-label="Status: {{.Status}}"></div>
            </div>
            <div class="flex-1 min-w-0 ml-2">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-foreground truncate">{{.Name}}</span>
                    <span class="text-[9px] text-muted-foreground font-mono uppercase shrink-0 px-1.5 py-0.5 rounded bg-muted/50">{{.Type}}</span>
                </div>
                <p class="text-[10px] text-muted-foreground font-mono truncate mt-0.5 hidden sm:block">{{.Target}}</p>
            </div>
            <div class="w-36 shrink-0 hidden md:flex items-center justify-center space-x-px mx-2">
                {{if gt .UptimeTotal 0}}
                <div class="flex items-center space-x-px" id="checks-{{.MonitorID}}"></div>
                {{else}}
                <span class="text-[9px] text-muted-foreground">No data</span>
                {{end}}
            </div>
            <div class="w-14 shrink-0 hidden md:flex items-center justify-end ml-2">
                <span class="text-xs font-mono font-medium
                    {{if ge .UptimePercent 99.0}}text-emerald-400
                    {{else if ge .UptimePercent 95.0}}text-amber-400
                    {{else}}text-red-400{{end}}">{{formatPercent .UptimePercent}}%</span>
            </div>
            <div class="w-20 shrink-0 hidden md:flex items-center justify-end ml-3">
                {{if eq .Type "system"}}
                <span class="text-xs font-mono text-foreground">{{if .MetricValue}}{{.MetricValue}}{{else}}No data{{end}}</span>
                {{else if eq .Type "docker"}}
                <span class="text-xs font-mono {{if eq .Status "up"}}text-emerald-400{{else}}text-red-400{{end}}">{{if eq .Status "up"}}Running{{else}}Stopped{{end}}</span>
                {{else if eq .Type "database"}}
                <span class="text-xs font-mono text-muted-foreground" id="resp-{{.MonitorID}}">No data</span>
                {{else}}
                <span class="text-xs font-mono text-muted-foreground">No data</span>
                {{end}}
            </div>
            <div class="w-5 shrink-0 flex justify-end">
                <i data-lucide="chevron-right" class="w-3 h-3 text-muted-foreground/20 group-hover:text-muted-foreground transition-smooth"></i>
            </div>
        </a>
        {{end}}
    </div>
</div>
{{end}}

<!-- Empty State (no monitors at all) -->
{{if not .Sparklines}}
<div class="bg-card border border-border rounded-lg mb-4">
    <div class="px-4 py-3 border-b border-border flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <h2 class="text-sm font-medium text-foreground">Monitor Health</h2>
        </div>
        <a href="/monitors" class="text-xs text-muted-foreground hover:text-foreground transition-smooth flex items-center space-x-1">
            <span>View all</span>
            <i data-lucide="arrow-right" class="w-3 h-3"></i>
        </a>
    </div>
    <div class="p-8 text-center">
        <div class="w-10 h-10 bg-muted/50 rounded-lg flex items-center justify-center mx-auto mb-3">
            <i data-lucide="activity" class="w-5 h-5 text-muted-foreground/40"></i>
        </div>
        {{if gt .Stats.TotalAgents 0}}
        <p class="text-sm text-foreground font-medium mb-1">You have {{.Stats.TotalAgents}} agent{{if gt .Stats.TotalAgents 1}}s{{end}} ready</p>
        <p class="text-xs text-muted-foreground mb-3">Create a monitor to start tracking your services.</p>
        <a href="/monitors/new" class="inline-flex items-center space-x-1.5 px-3 py-1.5 rounded-md bg-accent text-accent-foreground text-xs font-medium hover:bg-accent/90 transition-smooth">
            <i data-lucide="plus" class="w-3 h-3"></i>
            <span>Create a monitor</span>
        </a>
        {{else}}
        <p class="text-sm text-foreground font-medium mb-1">No monitors yet</p>
        <p class="text-xs text-muted-foreground mb-1">Deploy an agent first, then create monitors to track your services.</p>
        {{end}}
    </div>
</div>
{{end}}

<!-- Bottom Grid: Agents + Incidents -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

    <!-- Agents -->
    <div class="bg-card border border-border rounded-lg self-start">
        <div class="px-4 py-3 border-b border-border flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <h2 class="text-sm font-medium text-foreground">Agents</h2>
                <div class="flex items-center space-x-1.5">
                    <div class="w-1.5 h-1.5 rounded-full {{if gt .Stats.OnlineAgents 0}}bg-emerald-400{{else}}bg-muted-foreground{{end}}"></div>
                    <span class="text-[10px] text-muted-foreground font-mono">{{.Stats.OnlineAgents}}/{{.Stats.TotalAgents}} online</span>
                </div>
            </div>
            <button @click="openAgentModal"
                    class="px-3 py-1.5 bg-accent text-accent-foreground text-xs font-medium rounded-md hover:bg-accent/90 transition-colors"
                    aria-label="Create new agent">
                New Agent
            </button>
        </div>
        <div id="agents-container"
             hx-get="/dashboard" hx-trigger="agentCreated from:body" hx-select="#agents-container" hx-target="#agents-container" hx-swap="outerHTML"
             hx-ext="sse" sse-connect="/sse/events">
            {{if .Agents}}
            <div class="divide-y divide-border/30" id="agents-grid">
                {{range .Agents}}
                <div id="agent-{{.ID}}" class="flex items-center justify-between px-4 py-2.5 transition-smooth hover:bg-card-elevated" sse-swap="agent-status:{{.ID}}">
                    <div class="flex items-center space-x-3">
                        <div class="w-7 h-7 rounded-md {{if .IsOnline}}bg-emerald-500/10{{else}}bg-muted/50{{end}} flex items-center justify-center">
                            <i data-lucide="server" class="w-3.5 h-3.5 {{if .IsOnline}}text-emerald-400{{else}}text-muted-foreground{{end}}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-foreground">{{.Name}}</p>
                            <p class="text-[10px] text-muted-foreground">
                                {{if .LastSeenAt}}{{formatTimeAgo .LastSeenAt}}{{else}}Never connected{{end}}
                            </p>
                        </div>
                    </div>
                    <span class="text-[10px] px-1.5 py-0.5 rounded font-mono flex items-center space-x-1
                        {{if .IsOnline}}bg-emerald-500/15 text-emerald-400{{else}}bg-muted text-muted-foreground{{end}}">
                        {{if .IsOnline}}<span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse-dot inline-block"></span>{{end}}
                        <span>{{.Status}}</span>
                    </span>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="px-4 py-6">
                <p class="text-sm font-medium text-foreground mb-4">Get started in 3 steps</p>
                <div class="space-y-3">
                    <div class="flex items-start space-x-3">
                        <span class="shrink-0 w-5 h-5 rounded-full bg-accent/15 text-accent text-[10px] font-bold flex items-center justify-center mt-0.5">1</span>
                        <div>
                            <p class="text-xs font-medium text-foreground">Create an agent</p>
                            <p class="text-[10px] text-muted-foreground mt-0.5">Click <strong>New Agent</strong> above to register an agent and get an API key.</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="shrink-0 w-5 h-5 rounded-full bg-accent/15 text-accent text-[10px] font-bold flex items-center justify-center mt-0.5">2</span>
                        <div>
                            <p class="text-xs font-medium text-foreground">Install the agent</p>
                            <p class="text-[10px] text-muted-foreground mt-0.5 font-mono bg-muted/50 rounded px-1.5 py-1 mt-1 select-all">curl -fsSL https://usewatchdog.dev/install | bash</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="shrink-0 w-5 h-5 rounded-full bg-accent/15 text-accent text-[10px] font-bold flex items-center justify-center mt-0.5">3</span>
                        <div>
                            <p class="text-xs font-medium text-foreground">Create monitors</p>
                            <p class="text-[10px] text-muted-foreground mt-0.5">Add HTTP, TCP, Ping, or TLS monitors to track your services.</p>
                        </div>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Active Incidents -->
    <div class="bg-card border border-border rounded-lg self-start">
        <div class="px-4 py-3 border-b border-border flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <h2 class="text-sm font-medium text-foreground">Active Incidents</h2>
            </div>
            {{if .IncidentsWithMonitors}}
            <a href="/incidents" class="text-xs text-muted-foreground hover:text-foreground transition-smooth flex items-center space-x-1">
                <span>View all</span>
                <i data-lucide="arrow-right" class="w-3 h-3"></i>
            </a>
            {{end}}
        </div>
        {{if .IncidentsWithMonitors}}
        <div class="divide-y divide-border/30">
            {{range .IncidentsWithMonitors}}
            <div class="px-4 py-2.5 flex items-center justify-between transition-smooth hover:bg-card-elevated">
                <div class="flex items-center space-x-3">
                    <div class="w-7 h-7 rounded-md {{if eq (print .Incident.Status) "open"}}bg-red-500/10{{else}}bg-yellow-500/10{{end}} flex items-center justify-center">
                        <i data-lucide="{{if eq (print .Incident.Status) "open"}}alert-circle{{else}}clock{{end}}"
                           class="w-3.5 h-3.5 {{if eq (print .Incident.Status) "open"}}text-red-400{{else}}text-yellow-400{{end}}"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-foreground">{{if .Monitor}}{{.Monitor.Name}}{{else}}Unknown Monitor{{end}}</p>
                        <p class="text-[10px] text-muted-foreground">{{formatTimeAgo .Incident.StartedAt}} &middot; <span class="font-mono">{{formatDuration .Incident.Duration}}</span></p>
                    </div>
                </div>
                <span class="text-[10px] px-1.5 py-0.5 rounded font-mono
                    {{if eq (print .Incident.Status) "open"}}bg-red-500/15 text-red-400
                    {{else}}bg-yellow-500/15 text-yellow-400{{end}}">
                    {{.Incident.Status}}
                </span>
            </div>
            {{end}}
        </div>
        {{else}}
        <div class="text-center py-8">
            <div class="w-12 h-12 bg-emerald-500/5 rounded-lg flex items-center justify-center mx-auto mb-3">
                <i data-lucide="check-circle-2" class="w-6 h-6 text-emerald-400/40"></i>
            </div>
            <p class="text-sm text-muted-foreground">No active incidents</p>
            <a href="/incidents?status=all" class="text-xs text-muted-foreground/60 hover:text-muted-foreground mt-1 inline-block transition-smooth">View incident history</a>
        </div>
        {{end}}
    </div>
</div>

<!-- Chart + Sparkline Data -->
{{if .Sparklines}}
<script type="application/json" id="sparkline-data">{{toJSON .Sparklines}}</script>
<script nonce="{{.Nonce}}">
document.addEventListener('DOMContentLoaded', function() {
    var sparklineEl = document.getElementById('sparkline-data');
    if (!sparklineEl) return;

    try {
        var sparklines = JSON.parse(sparklineEl.textContent);

        for (var i = 0; i < sparklines.length; i++) {
            var s = sparklines[i];
            var isInfra = (s.Type === 'system' || s.Type === 'docker' || s.Type === 'database');

            // Sparklines (only for service monitors â€” infra has no canvas)
            if (!isInfra && s.Latencies && s.Latencies.length > 0) {
                var color = s.Status === 'up' ? '#22c55e' : (s.Status === 'down' ? '#ef4444' : '#a1a1aa');
                var allZero = s.Latencies.every(function(v) { return v === 0; });
                if (allZero) {
                    createSparkline('spark-' + s.MonitorID, s.Latencies.map(function() { return 0; }), '#a1a1aa');
                    var respEl = document.getElementById('resp-' + s.MonitorID);
                    if (respEl) respEl.textContent = '0ms';
                } else {
                    createSparkline('spark-' + s.MonitorID, s.Latencies, color);
                    var respEl = document.getElementById('resp-' + s.MonitorID);
                    if (respEl) {
                        respEl.textContent = s.Latencies[s.Latencies.length - 1] + 'ms';
                    }
                }
            }

            // Database infra monitors: show latest latency in value column
            if (s.Type === 'database' && s.Latencies && s.Latencies.length > 0) {
                var dbRespEl = document.getElementById('resp-' + s.MonitorID);
                if (dbRespEl) {
                    dbRespEl.textContent = s.Latencies[s.Latencies.length - 1] + 'ms';
                }
            }

            // Per-check uptime segments
            if (s.CheckResults && s.CheckResults.length > 0) {
                var container = document.getElementById('checks-' + s.MonitorID);
                if (container) {
                    container.innerHTML = '';
                    var successCount = 0;
                    for (var j = 0; j < s.CheckResults.length; j++) {
                        if (s.CheckResults[j] === 1) successCount++;
                    }
                    for (var j = 0; j < s.CheckResults.length; j++) {
                        var seg = document.createElement('div');
                        seg.style.width = '5px';
                        seg.style.height = '16px';
                        seg.style.borderRadius = '2px';
                        var isUp = s.CheckResults[j] === 1;
                        seg.className = isUp ? 'bg-emerald-500/70' : 'bg-red-500/70';
                        seg.title = 'Check ' + (j + 1) + ': ' + (isUp ? 'up' : 'down') + ' (' + successCount + '/' + s.CheckResults.length + ' total)';
                        container.appendChild(seg);
                    }
                    for (var k = s.CheckResults.length; k < 20; k++) {
                        var empty = document.createElement('div');
                        empty.style.width = '5px';
                        empty.style.height = '16px';
                        empty.style.borderRadius = '2px';
                        empty.className = 'bg-muted/40';
                        container.appendChild(empty);
                    }
                }
            }
        }
    } catch(e) {}
});
</script>
{{end}}

<!-- New Agent Modal -->
<div id="new-agent-modal" x-data="agentModal" @open-agent-modal.window="open"
     x-show="show" x-cloak
     role="dialog" aria-label="Create agent"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
     x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
    <div class="bg-card border border-border rounded-lg shadow-lg w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto"
         x-show="show"
         x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
         @click.outside="close">
        <div class="px-4 py-3 border-b border-border flex items-center justify-between">
            <h3 class="text-sm font-medium text-foreground">Create Agent</h3>
            <button @click="close"
                    class="text-muted-foreground hover:text-foreground" aria-label="Close">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <form id="agent-form" hx-post="/agents" hx-target="#agent-result" hx-swap="innerHTML">
            {{if .CSRFToken}}<input type="hidden" name="_csrf" value="{{.CSRFToken}}">{{end}}
            <div class="p-4">
                <label class="block text-xs text-muted-foreground mb-1">Agent Name</label>
                <input type="text" name="name" required placeholder="e.g. Homelab, Production, Staging"
                       class="w-full px-3 py-2 bg-background border border-border rounded-md text-sm text-foreground placeholder:text-muted-foreground/50 focus:outline-none focus:ring-1 focus:ring-accent">
            </div>
            <div class="px-4 py-3 border-t border-border flex justify-end space-x-2">
                <button type="button" @click="close"
                        class="px-3 py-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors">
                    Cancel
                </button>
                <button type="submit"
                        class="px-3 py-1.5 bg-accent text-accent-foreground text-xs font-medium rounded-md hover:bg-accent/90 transition-colors">
                    Create Agent
                </button>
            </div>
        </form>
        <div id="agent-result" class="px-4 pb-4 overflow-hidden"></div>
    </div>
</div>
{{end}}
